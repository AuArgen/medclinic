<?php

namespace App\Http\Controllers;

use Illuminate\Http\Request;

class DocumentationController extends Controller
{
    public function index(Request $request)
    {
        $sections = $this->getDocumentationSections();
        $searchTerm = $request->input('search');

        if ($searchTerm) {
            $sections = $this->filterSections($sections, $searchTerm);
        }

        return view('documentation.index', compact('sections', 'searchTerm'));
    }

    private function getDocumentationSections(): array
    {
        return [
            [
                'title' => 'Жалпы колдонуучулар (Коноктор)',
                'content' => [
                    'Катталуу' => '1. Сайттын жогорку оң бурчундагы "Катталуу" баскычын басыңыз. 2. Аты-жөнүңүздү, электрондук почтаңызды жана паролуңузду киргизиңиз. 3. "Катталуу" баскычын басыңыз.',
                    'Сайтка кирүү' => '1. "Кирүү" баскычын басыңыз. 2. Катталган электрондук почтаңызды жана паролуңузду киргизиңиз. 3. "Кирүү" баскычын басыңыз.',
                    'Врачтарды көрүү' => 'Навигациядагы "Врачтар" шилтемесин басып, бардык врачтардын тизмесин, адистигин жана сүрөттөрүн көрө аласыз. Врачтын профилине кирүү үчүн "Профилин көрүү" баскычын басыңыз.',
                    'Отделдерди көрүү' => 'Навигациядагы "Отделдер" шилтемесин басып, клиниканын бардык отделдери менен тааныша аласыз. "Көбүрөөк маалымат" шилтемеси аркылуу отделдин толук маалыматын, ага тиешелүү врачтарды көрө аласыз.',
                ],
            ],
            [
                'title' => 'Катталган колдонуучулар (Кардарлар)',
                'content' => [
                    'Врачка жазылуу' => '1. "Врачтар" баракчасынан керектүү врачты таап, "Профилин көрүү" баскычын басыңыз. 2. Врачтын профилинен "Жазылуу" баскычын басыңыз. 3. Каалаган датаны жана убакытты тандап, "Жазылуу" баскычын басыңыз. Сиздин брондооңуз "Текшерилүүдө" статусун алат.',
                    'Менин брондоолорум' => 'Навигациядагы "Менин брондоолорум" шилтемесин басып, бардык брондоолоруңуздун тизмесин, статусун ("Текшерилүүдө", "Тастыкталды", "Жокко чыгарылды") жана акыркы өзгөрүү убактысын көрө аласыз.',
                    'Врач менен сүйлөшүү' => '1. Врачтын профилинен "Билдирүү жазуу" баскычын басыңыз. 2. Ачылган баракчада билдирүүңүздү жазып, "Жөнөтүү" баскычын басыңыз. 3. Бардык сүйлөшүүлөрдү навигациядагы "Билдирүүлөр" шилтемеси аркылуу көрө аласыз.',
                    'Профильди оңдоо' => '1. Жогорку оң бурчтагы аты-жөнүңүздү басып, "Профиль" шилтемесин тандаңыз. 2. Бул баракчадан аты-жөнүңүздү, электрондук почтаңызды жана паролуңузду өзгөртө аласыз.',
                ],
            ],
            [
                'title' => 'Медиктер',
                'content' => [
                    'Брондоолорду башкаруу' => 'Навигациядагы "Менин брондоолорум" шилтемеси аркылуу сизге келген брондоолордун тизмесин көрө аласыз. Ар бир брондоонун статусун "Тастыкталды", "Жокко чыгарылды" же "Аяктады" деп өзгөртө аласыз.',
                    'Пациенттер менен сүйлөшүү' => 'Навигациядагы "Билдирүүлөр" шилтемеси аркылуу пациенттерден келген билдирүүлөрдү көрүп, аларга жооп бере аласыз.',
                ],
            ],
            [
                'title' => 'Администратор',
                'content' => [
                    'Башкаруу панели' => 'Навигациядагы "Башкаруу" dropdown менюсу аркылуу бардык административдик функцияларга жете аласыз.',
                    'Колдонуучуларды башкаруу' => '"Башкаруу" -> "Колдонуучулар" бөлүмүнө өтүп, жаңы колдонуучуларды (анын ичинде медиктерди) кошуп, алардын маалыматтарын, ролун, сүрөтүн өзгөртүп, же өчүрө аласыз.',
                    'Отделдерди башкаруу' => '"Башкаруу" -> "Отделдер" бөлүмүнө өтүп, жаңы отделдерди жана под-отделдерди түзүп, алардын маалыматтарын (аталышы, сүрөтү, иконкасы, толук маалыматы) өзгөртө аласыз.',
                    'Расписание түзүү' => '"Башкаруу" -> "Расписаниелер" бөлүмүнө өтүп, врачтар үчүн жумуш графигин түзө аласыз.',
                    'Брондоолорду башкаруу' => '"Башкаруу" -> "Брондоолор" бөлүмүнөн бардык брондоолорду көрүп, алардын убактысын, статусун же дайындалган палатасын өзгөртө аласыз.',
                    'Палаталарды башкаруу' => 'Алгач "Корпустарды", андан кийин "Этаждарды", аягында "Палаталарды" ("Башкаруу" менюсунан) түзүп, клиниканын структурасын башкара аласыз.',
                    'Сайттын жөндөөлөрү' => '"Башкаруу" -> "Жөндөөлөр" бөлүмүнөн сайттын негизги аталышын жана логотибин өзгөртө аласыз.',
                ],
            ],
        ];
    }

    private function filterSections(array $sections, string $searchTerm): array
    {
        $filteredSections = [];
        $lowerSearchTerm = mb_strtolower($searchTerm, 'UTF-8');

        foreach ($sections as $section) {
            $filteredContent = [];
            foreach ($section['content'] as $key => $value) {
                if (mb_strpos(mb_strtolower($key, 'UTF-8'), $lowerSearchTerm) !== false || mb_strpos(mb_strtolower($value, 'UTF-8'), $lowerSearchTerm) !== false) {
                    $filteredContent[$key] = $value;
                }
            }

            if (mb_strpos(mb_strtolower($section['title'], 'UTF-8'), $lowerSearchTerm) !== false || !empty($filteredContent)) {
                $section['content'] = !empty($filteredContent) ? $filteredContent : $section['content'];
                $filteredSections[] = $section;
            }
        }

        return $filteredSections;
    }
}
